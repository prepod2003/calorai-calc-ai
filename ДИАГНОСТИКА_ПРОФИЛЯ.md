# Диагностика проблемы с расчетом профиля

## Проблема
При нажатии на кнопку "Рассчитать с помощью AI" в профиле пользователя поля остаются со значением "0".

## Внесенные исправления

### 1. Улучшенный парсер JSON (aiService.ts)
**Проблема:** AI может возвращать JSON обернутый в markdown блоки или текст.

**Решение:** Добавлен умный парсер с fallback:
```typescript
if (isJson) {
    console.log('[AI Response] Raw content:', content);
    try {
        return JSON.parse(content);
    } catch (e) {
        console.warn('[AI Response] Failed to parse as JSON, trying to extract JSON from text');
        const jsonMatch = content.match(/\{[\s\S]*\}/);  
        if (jsonMatch) {
            console.log('[AI Response] Extracted JSON:', jsonMatch[0]);
            return JSON.parse(jsonMatch[0]);
        }
        throw new Error('Не удалось извлечь JSON из ответа AI');
    }
}
```

### 2. Улучшенный промпт
**Проблема:** AI мог добавлять объяснения или форматирование.

**Решение:** Явное указание формата:
```
ВАЖНО: Ответь СТРОГО в формате JSON без дополнительного текста, 
объяснений или markdown форматирования. Верни только чистый JSON объект.
```

### 3. Увеличен лимит токенов
**Проблема:** 1024 токенов могло быть недостаточно для некоторых моделей.

**Решение:** Увеличен до 2048 токенов для функции calculateDailyGoals.

### 4. Комплексное логирование
Добавлено подробное логирование на всех уровнях:
- `[AI Response]` - сырой ответ от AI
- `[calculateDailyGoals]` - данные после парсинга и расчета
- `[UserProfile]` - данные в UI компоненте

## Инструкция по диагностике

### Шаг 1: Откройте консоль разработчика
1. В браузере нажмите `F12` или `Ctrl+Shift+I` (Chrome/Firefox)
2. Перейдите на вкладку "Console"

### Шаг 2: Попробуйте выполнить расчет
1. Откройте профиль (иконка пользователя в шапке)
2. Заполните все поля
3. Нажмите "Рассчитать с помощью AI"
4. Наблюдайте за логами в консоли

### Шаг 3: Анализируйте логи

#### Успешный сценарий:
```
[UserProfile] Starting calculation with formData: {gender: "male", age: 30, ...}
[UserProfile] Config: {providerId: "openrouter", hasToken: true, model: "..."}
[AI Response] Raw content: {"bmr": 1750, "tdee": 2450, ...}
[calculateDailyGoals] Received data: {bmr: 1750, tdee: 2450, ...}
[calculateDailyGoals] Calculated result: {bmr: 1750, tdee: 2450, ...}
[UserProfile] Received goals from AI: {bmr: 1750, tdee: 2450, ...}
[UserProfile] Setting new goals form: {bmr: "1750", tdee: "2450", ...}
```

#### Проблемные сценарии:

**Сценарий А: AI возвращает текст вместо JSON**
```
[AI Response] Raw content: "Вот ваш расчет:\n```json\n{\"bmr\": 1750}\n```"
[AI Response] Failed to parse as JSON, trying to extract JSON from text
[AI Response] Extracted JSON: {"bmr": 1750, ...}
```
✅ Должно работать благодаря новому парсеру

**Сценарий Б: Проблема с токеном/моделью**
```
[UserProfile] Starting calculation...
[UserProfile] Config: {providerId: "openrouter", hasToken: false, model: ""}
[UserProfile] Error during calculation: Токен или модель не настроены
```
❌ **Решение:** Проверьте настройки API (иконка ⚙️)

**Сценарий В: Ошибка сети**
```
[UserProfile] Starting calculation...
[calculateDailyGoals] Error: HTTP 401: Unauthorized
```
❌ **Решение:** Проверьте правильность API-ключа

**Сценарий Г: AI не возвращает корректный JSON**
```
[AI Response] Raw content: "Извините, я не могу выполнить этот расчет"
[AI Response] Failed to parse as JSON, trying to extract JSON from text
Error: Не удалось извлечь JSON из ответа AI
```
❌ **Решение:** Попробуйте другую модель или провайдера

### Шаг 4: Возможные решения

1. **Если нет логов вообще:**
   - Убедитесь, что используете обновленную версию (пересоберите: `npm run build`)
   - Очистите кэш браузера (Ctrl+Shift+Delete)

2. **Если AI возвращает не JSON:**
   - Попробуйте другую модель (в настройках ⚙️)
   - Некоторые модели лучше понимают инструкцию JSON_ONLY

3. **Если JSON парсится, но значения 0:**
   - Проверьте лог `[calculateDailyGoals] Received data:`
   - Возможно AI возвращает null или пустые строки
   - Функция `parseNutrientValue` конвертирует их в 0

4. **Если все логи показывают корректные данные, но UI не обновляется:**
   - Проблема в React state
   - Проверьте лог `[UserProfile] Setting new goals form:`
   - Убедитесь, что модальное окно профиля не закрывается

## Дополнительные улучшения

Если проблема сохраняется, можно добавить:

1. **Fallback на ручной ввод данных**
2. **Предустановленные шаблоны расчета** (без AI)
3. **Retry механизм** с автоматической повторной попыткой
4. **Альтернативные промпты** для разных типов моделей

## Обратная связь

После тестирования предоставьте:
1. Скриншот консоли с логами
2. Какой AI-провайдер и модель используете
3. На каком шаге происходит ошибка

Это поможет точнее определить проблему и внести дополнительные исправления.
